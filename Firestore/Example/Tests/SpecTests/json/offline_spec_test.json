{
  "Empty queries are resolved if client goes offline": {
    "describeName": "Offline:",
    "itName": "Empty queries are resolved if client goes offline",
    "tags": [],
    "config": {
      "useGarbageCollection": true
    },
    "steps": [
      {
        "userListen": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      }
    ]
  },
  "A successful message delays offline status": {
    "describeName": "Offline:",
    "itName": "A successful message delays offline status",
    "tags": [],
    "config": {
      "useGarbageCollection": true
    },
    "steps": [
      {
        "userListen": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchAck": [
          2
        ]
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      }
    ]
  },
  "Removing all listeners delays \"Offline\" status on next listen": {
    "describeName": "Offline:",
    "itName": "Removing all listeners delays \"Offline\" status on next listen",
    "tags": [],
    "config": {
      "useGarbageCollection": true
    },
    "steps": [
      {
        "userListen": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "userUnlisten": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {}
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "userListen": [
          4,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "4": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      }
    ]
  },
  "Queries revert to fromCache=true when offline.": {
    "describeName": "Offline:",
    "itName": "Queries revert to fromCache=true when offline.",
    "tags": [],
    "config": {
      "useGarbageCollection": true
    },
    "steps": [
      {
        "userListen": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchAck": [
          2
        ]
      },
      {
        "watchEntity": {
          "docs": [
            [
              "collection/a",
              1000,
              {
                "key": "a"
              }
            ]
          ],
          "targets": [
            2
          ]
        }
      },
      {
        "watchCurrent": [
          [
            2
          ],
          "resume-token-1000"
        ],
        "watchSnapshot": 1000,
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "added": [
              [
                "collection/a",
                1000,
                {
                  "key": "a"
                }
              ]
            ],
            "errorCode": 0,
            "fromCache": false,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": "resume-token-1000"
            }
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchAck": [
          2
        ]
      },
      {
        "watchEntity": {
          "docs": [],
          "targets": [
            2
          ]
        }
      },
      {
        "watchCurrent": [
          [
            2
          ],
          "resume-token-1000"
        ],
        "watchSnapshot": 1000,
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": false,
            "hasPendingWrites": false
          }
        ]
      }
    ]
  },
  "Queries with limbo documents handle going offline.": {
    "describeName": "Offline:",
    "itName": "Queries with limbo documents handle going offline.",
    "tags": [],
    "config": {
      "useGarbageCollection": true
    },
    "steps": [
      {
        "userListen": [
          2,
          {
            "path": "collection",
            "filters": [],
            "orderBys": []
          }
        ],
        "stateExpect": {
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        }
      },
      {
        "watchAck": [
          2
        ]
      },
      {
        "watchEntity": {
          "docs": [
            [
              "collection/a",
              1000,
              {
                "key": "a"
              }
            ]
          ],
          "targets": [
            2
          ]
        }
      },
      {
        "watchCurrent": [
          [
            2
          ],
          "resume-token-1000"
        ],
        "watchSnapshot": 1000,
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "added": [
              [
                "collection/a",
                1000,
                {
                  "key": "a"
                }
              ]
            ],
            "errorCode": 0,
            "fromCache": false,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchReset": [
          2
        ]
      },
      {
        "watchCurrent": [
          [
            2
          ],
          "resume-token-1001"
        ],
        "watchSnapshot": 1001,
        "stateExpect": {
          "limboDocs": [
            "collection/a"
          ],
          "activeTargets": {
            "1": {
              "query": {
                "path": "collection/a",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            },
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            }
          }
        },
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "errorCode": 0,
            "fromCache": true,
            "hasPendingWrites": false
          }
        ]
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        },
        "stateExpect": {
          "activeTargets": {
            "1": {
              "query": {
                "path": "collection/a",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": ""
            },
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": "resume-token-1001"
            }
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchStreamClose": {
          "error": {
            "code": 14,
            "message": "Simulated Backend Error"
          }
        }
      },
      {
        "watchAck": [
          2
        ]
      },
      {
        "watchEntity": {
          "docs": [],
          "targets": [
            2
          ]
        }
      },
      {
        "watchCurrent": [
          [
            2
          ],
          "resume-token-1001"
        ],
        "watchSnapshot": 1001
      },
      {
        "watchAck": [
          1
        ]
      },
      {
        "watchEntity": {
          "docs": [],
          "targets": [
            1
          ]
        }
      },
      {
        "watchCurrent": [
          [
            1
          ],
          "resume-token-1001"
        ],
        "watchSnapshot": 1001,
        "expect": [
          {
            "query": {
              "path": "collection",
              "filters": [],
              "orderBys": []
            },
            "removed": [
              [
                "collection/a",
                1000,
                {
                  "key": "a"
                }
              ]
            ],
            "errorCode": 0,
            "fromCache": false,
            "hasPendingWrites": false
          }
        ],
        "stateExpect": {
          "limboDocs": [],
          "activeTargets": {
            "2": {
              "query": {
                "path": "collection",
                "filters": [],
                "orderBys": []
              },
              "resumeToken": "resume-token-1001"
            }
          }
        }
      }
    ]
  }
}
